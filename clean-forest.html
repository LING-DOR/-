<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Cleanup - æ£®æ—å¤§æ¸…ç†</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡å­— */
            background-color: #1a2a0a; /* æ·±ç»¿è‰² */
        }

        /* --- æ¸¸æˆå®¹å™¨ (æ£®æ—åœ°é¢) --- */
        #game-container {
            width: 100%;
            height: 100%;
            
            /* ========================================================== */
            /* !!! ä½¿ç”¨æ‚¨æä¾›çš„ç»å¯¹è·¯å¾„ã€‚æ³¨æ„ï¼šæœ¬åœ°è·¯å¾„éœ€ä½¿ç”¨ file:/// åè®®ï¼Œä¸” Windows è·¯å¾„éœ€å°† \ æ›¿æ¢ä¸º / */
            /* ========================================================== */
            background-image: url('senlin.png');
            
            background-size: cover;
            background-position: center;
            position: relative;
            /* é¼ æ ‡å…‰æ ‡æ”¹ä¸ºæ ‘å¶ */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><text y="20" font-size="20">ğŸƒ</text></svg>') 12 12, auto;
            transition: filter 0.5s ease;
        }

        /* --- æ°›å›´é®ç½© (è„ä¹±/æ±¡æŸ“æ•ˆæœ) --- */
        #gloom-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* è°ƒæ•´ä¸ºæ›´è‡ªç„¶çš„æ£®æ—æ±¡æŸ“æ•ˆæœï¼Œæ¨¡æ‹Ÿç°æš—æ„Ÿ */
            background: radial-gradient(circle, rgba(60, 80, 40, 0.2) 0%, rgba(30, 40, 20, 0.8) 100%);
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€é®ç½©ç‚¹å‡»ç‰©å“ */
            transition: opacity 0.5s ease;
            z-index: 10;
        }

        /* --- UI ç•Œé¢ --- */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            color: #f0f0f0; /* æµ…è‰²æ–‡å­—åœ¨æ·±è‰²èƒŒæ™¯ä¸Šæ›´æ¸…æ™° */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        #timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #f0f0f0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            transition: color 0.5s;
        }

        h1 { margin: 0; font-size: 24px; }
        p { margin: 5px 0; font-size: 18px; }

        #progress-bar-container {
            width: 200px;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.5);
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #28a745); /* ä»é»„è‰²åˆ°æ£®æ—ç»¿è‰² */
            transition: width 0.3s ease;
        }

        /* --- æ±¡æŸ“ç‰©å“æ ·å¼ --- */
        .pollution {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            z-index: 5;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        .pollution:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .pollution.cleaning {
            transform: scale(0) rotate(180deg);
            opacity: 0;
        }

        /* æ¯’è›‡ä¼šæœ‰åŠ¨ç”» */
        .snake {
            font-size: 35px;
            z-index: 6;
            transition: top 1s ease-in-out, left 1s ease-in-out;
            animation: subtleShake 0.5s infinite alternate;
        }
        @keyframes subtleShake {
            from { transform: rotate(0deg); }
            to { transform: rotate(5deg); }
        }

        /* --- èƒœåˆ©/å¤±è´¥å¼¹çª— --- */
        #victory-screen, #failure-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }

        #victory-screen.show, #failure-screen.show {
            opacity: 1;
            pointer-events: auto;
        }

        .btn {
            padding: 15px 30px;
            font-size: 24px;
            background: #28a745; /* æ£®æ—ç»¿ */
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            transition: transform 0.1s, background 0.2s;
            margin-top: 15px;
        }

        .btn:hover { background: #218838; transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }

        /* --- ç²’å­ç‰¹æ•ˆ --- */
        .sparkle {
            position: absolute;
            pointer-events: none;
            animation: riseAndFade 1s forwards;
            font-size: 20px;
            z-index: 8;
        }

        @keyframes riseAndFade {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="gloom-overlay"></div>
        
        <div id="pollution-layer"></div>
    </div>

    <div id="ui-layer">
        <h1>ğŸŒ³ Forest Cleanup</h1>
        <p>å…³å¡: <span id="level-display">1</span></p>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <div id="timer-display">
        ğŸ•’ <span id="time-left">00</span>
    </div>

    <div id="victory-screen">
        <h1 style="color: #28a745; font-size: 50px; margin-bottom: 20px;">ğŸŒ² æ£®æ—ç„•æ–°! ğŸŒ³</h1>
        <p style="color: #555; margin-bottom: 30px;">æ­å–œï¼æ‚¨åœ¨è§„å®šæ—¶é—´å†…å®Œæˆäº†æ¸…ç†ã€‚</p>
        <button class="btn" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
    </div>

    <div id="failure-screen">
        <h1 style="color: #c0392b; font-size: 50px; margin-bottom: 20px;">â° æ—¶é—´è€—å°½! ğŸ˜¥</h1>
        <p style="color: #555; margin-bottom: 30px;">å¾ˆé—æ†¾ï¼Œæ‚¨æ²¡èƒ½åœ¨è§„å®šæ—¶é—´å†…æ¸…ç†æ£®æ—ã€‚</p>
        <button class="btn" style="background: #c0392b;" onclick="nextLevel()">é‡è¯•æœ¬å…³</button>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½® ---
        // UIå®‰å…¨åŒºåŸŸé…ç½® (å·¦ä¸Šè§’)
        const UI_SAFE_MARGIN_X = 280; // UI å®½åº¦ + è¾¹è·
        const UI_SAFE_MARGIN_Y = 180; // UI é«˜åº¦ + è¾¹è·

        // å€’è®¡æ—¶é…ç½®
        const BASE_TIME = 30; // åˆå§‹æ—¶é—´ (ç§’)
        const TIME_DECREMENT = 3; // æ¯å‡ä¸€çº§å‡å°‘çš„æ—¶é—´ (ç§’)
        const MIN_TIME = 10; // æœ€ä½æ—¶é—´é™åˆ¶ (ç§’)


        // æ±¡æŸ“ç‰©å“ï¼šä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„ Emoji
        const pollutionTypes = ['ğŸ—‘ï¸', 'ğŸ§´', 'â­•', 'ğŸ’”', 'ğŸš¬', 'ğŸ›ï¸', 'ğŸ¥«']; 
        // åŠ¨æ€å®³è™«ï¼šæ¯’è›‡
        const pestTypes = ['ğŸ']; 

        let state = {
            level: 1,
            totalItems: 0,
            cleanedItems: 0,
            isGameOver: false
        };

        // è®¡æ—¶å™¨å˜é‡
        let timerId = null;
        let gameTimer = 0;

        const container = document.getElementById('game-container');
        const pollutionLayer = document.getElementById('pollution-layer');
        const gloomOverlay = document.getElementById('gloom-overlay');
        const progressBar = document.getElementById('progress-bar');
        const victoryScreen = document.getElementById('victory-screen');
        const failureScreen = document.getElementById('failure-screen');
        const levelDisplay = document.getElementById('level-display');
        const timeLeftDisplay = document.getElementById('time-left');

        // --- éŸ³æ•ˆ (åˆæˆéŸ³ - æ¨¡æ‹Ÿç‚¹å‡»å’Œèƒœåˆ©å£°) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playPopSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function playWinSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 1);
        }

        // --- è®¡æ—¶å™¨é€»è¾‘ ---
        function calculateTimeLimit(level) {
            let timeLimit = BASE_TIME - (level - 1) * TIME_DECREMENT;
            return Math.max(timeLimit, MIN_TIME);
        }

        function startTimer() {
            stopTimer(); // ç¡®ä¿æ—§çš„è®¡æ—¶å™¨è¢«æ¸…é™¤
            gameTimer = calculateTimeLimit(state.level);
            timeLeftDisplay.innerText = gameTimer;
            
            timerId = setInterval(() => {
                gameTimer--;
                timeLeftDisplay.innerText = gameTimer;

                // å‰©ä½™æ—¶é—´å°äºç­‰äº5ç§’æ—¶å˜çº¢ï¼Œå¢åŠ ç´§å¼ æ„Ÿ
                if (gameTimer <= 5) {
                    timeLeftDisplay.parentElement.style.color = '#e74c3c';
                } else {
                    timeLeftDisplay.parentElement.style.color = '#f0f0f0';
                }

                if (gameTimer <= 0) {
                    stopTimer();
                    gameOver(false); // è¶…æ—¶å¤±è´¥
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerId !== null) {
                clearInterval(timerId);
                timerId = null;
            }
        }

        // --- æ¸¸æˆå¤±è´¥/ç»“æŸé€»è¾‘ ---

        function gameOver(isWin) {
            state.isGameOver = true;
            stopTimer(); // åœæ­¢è®¡æ—¶

            if (isWin) {
                playWinSound();
                setTimeout(() => {
                    victoryScreen.classList.add('show');
                }, 500);
            } else {
                // å¤±è´¥é€»è¾‘
                setTimeout(() => {
                    failureScreen.classList.add('show');
                }, 500);
            }
        }


        // --- æ ¸å¿ƒé€»è¾‘ ---

        function initLevel() {
            // æ¸…ç†å¹¶é‡ç½®ç•Œé¢
            pollutionLayer.innerHTML = '';
            failureScreen.classList.remove('show');
            victoryScreen.classList.remove('show');

            // é‡ç½®çŠ¶æ€
            state.cleanedItems = 0;
            state.isGameOver = false;
            levelDisplay.innerText = state.level;
            
            // è®¡ç®—éš¾åº¦ (éšå…³å¡å¢åŠ ç‰©å“æ•°é‡)
            const pollutionCount = 10 + (state.level * 3); 
            const snakeCount = 2 + Math.floor(state.level / 2);
            state.totalItems = pollutionCount + snakeCount;

            updateAtmosphere();

            // ç”Ÿæˆé™æ€æ±¡æŸ“ç‰©å“
            for (let i = 0; i < pollutionCount; i++) {
                spawnPollution();
            }

            // ç”Ÿæˆæ¯’è›‡
            for (let i = 0; i < snakeCount; i++) {
                spawnSnake();
            }

            // !!! å¯åŠ¨è®¡æ—¶å™¨ !!!
            startTimer();
        }
        
        // é™åˆ¶æ±¡æŸ“ç‰©å“çš„ç”Ÿæˆä½ç½® (é¿å¼€ UI)
        function spawnPollution() {
            const el = document.createElement('div');
            el.classList.add('pollution');
            el.innerText = pollutionTypes[Math.floor(Math.random() * pollutionTypes.length)];
            
            let x, y;
            do {
                // éšæœºä½ç½® (é¢„ç•™è¾¹è· 50px)
                x = Math.random() * (window.innerWidth - 100) + 50;
                y = Math.random() * (window.innerHeight - 100) + 50;
                
                // æ£€æŸ¥æ˜¯å¦ä¸å·¦ä¸Šè§’UIåŒºåŸŸé‡å 
            } while (x < UI_SAFE_MARGIN_X && y < UI_SAFE_MARGIN_Y);

            const rot = Math.random() * 360;

            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            el.style.transform = `rotate(${rot}deg)`;

            // ç‚¹å‡»äº‹ä»¶
            el.onclick = (e) => cleanItem(e, el);
            pollutionLayer.appendChild(el);
        }

        function spawnSnake() {
            const el = document.createElement('div');
            el.classList.add('pollution', 'snake'); 
            el.innerText = pestTypes[0];
            
            // åˆå§‹ä½ç½®
            moveSnakeRandomly(el, true); // é¦–æ¬¡ç”Ÿæˆæ—¶å¼ºåˆ¶é¿å¼€ UI
            
            // å¯åŠ¨éšæœºç§»åŠ¨å¾ªç¯
            const moveInterval = setInterval(() => {
                if(!el.parentElement || state.isGameOver) { 
                    clearInterval(moveInterval);
                    return;
                }
                moveSnakeRandomly(el, false); // ç§»åŠ¨æ—¶ä¸éœ€è¦å¼ºåˆ¶é¿å¼€ UI
            }, 1000 + Math.random() * 2000); // æ¯1-3ç§’ç§»åŠ¨ä¸€æ¬¡

            el.onclick = (e) => cleanItem(e, el);
            pollutionLayer.appendChild(el);
        }

        function moveSnakeRandomly(el, initialSpawn = false) {
            let x, y;
            do {
                x = Math.random() * (window.innerWidth - 50);
                y = Math.random() * (window.innerHeight - 50);
            } while (initialSpawn && x < UI_SAFE_MARGIN_X && y < UI_SAFE_MARGIN_Y); 

            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
        }

        function cleanItem(e, element) {
            if (state.isGameOver) return;
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (element.classList.contains('cleaning')) return;

            element.classList.add('cleaning');
            playPopSound();
            spawnSparkle(e.clientX, e.clientY);

            // å»¶è¿Ÿç§»é™¤ DOM
            setTimeout(() => {
                if (element.parentElement) {
                    element.remove();
                    state.cleanedItems++;
                    updateAtmosphere();
                    checkWin();
                }
            }, 200);
        }

        function spawnSparkle(x, y) {
            const sparkle = document.createElement('div');
            sparkle.innerText = 'âœ¨';
            sparkle.classList.add('sparkle');
            sparkle.style.left = (x - 10) + 'px';
            sparkle.style.top = (y - 10) + 'px';
            container.appendChild(sparkle);
            
            setTimeout(() => sparkle.remove(), 1000);
        }

        function updateAtmosphere() {
            // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
            const progress = state.cleanedItems / state.totalItems;
            
            // æ›´æ–°è¿›åº¦æ¡
            progressBar.style.width = `${progress * 100}%`;

            // æ›´æ–°é˜´æš—ç¨‹åº¦ (0% è¿›åº¦ = 0.8 é€æ˜åº¦, 100% è¿›åº¦ = 0 é€æ˜åº¦)
            const gloomOpacity = 0.8 - (progress * 0.8);
            gloomOverlay.style.opacity = Math.max(0, gloomOpacity);

            // èƒŒæ™¯é¢œè‰²å¾®è°ƒ (ä»æš—åˆ°äº®ï¼Œä¸å¡é€šé£æ ¼æ›´åŒ¹é…)
            container.style.filter = `brightness(${0.7 + (progress * 0.3)})`;
        }

        function checkWin() {
            if (state.cleanedItems >= state.totalItems) {
                gameOver(true); // èƒœåˆ©
            }
        }

        function nextLevel() {
            if (victoryScreen.classList.contains('show')) {
                // å¦‚æœæ˜¯èƒœåˆ©ï¼Œè¿›å…¥ä¸‹ä¸€å…³
                state.level++;
            } else {
                // å¦‚æœæ˜¯å¤±è´¥é‡è¯•ï¼Œå…³å¡ä¸å˜
                // state.level = state.level; 
            }
            initLevel();
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶ä¸åšå¤æ‚å¤„ç†
        window.onresize = () => {};

        // --- å¯åŠ¨æ¸¸æˆ ---
        initLevel();

    </script>
</body>
</html>